<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&display=swap");
      body {
        font-family: "Kantumruy Pro", sans-serif;
        background-color: #f0f4f8;
      }
      .loader {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #fff;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .form-container {
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      }
      .hidden-container {
        opacity: 0;
        transform: scale(0.95);
        pointer-events: none;
        display: none !important;
      }
      .visible-container {
        opacity: 1;
        transform: scale(1);
        pointer-events: auto;
        display: block;
      }

      .receipt-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px dashed #d1d5db;
      }
      .receipt-item-label {
        font-weight: 500;
        color: #4b5563;
      }
      .receipt-item-value {
        color: #1f2937;
        font-weight: 700;
      }

      .modal {
        transition: opacity 0.3s ease;
      }
      #camera-modal video,
      #camera-modal canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      #camera-modal video {
        transform: scaleX(-1);
      } /* Mirror front camera */

      .thumbnail-container {
        position: relative;
      }
      .thumbnail-remove-btn {
        position: absolute;
        top: -0.5rem;
        right: -0.5rem;
        background-color: rgba(239, 68, 68, 0.8);
        border-radius: 9999px;
        color: white;
        width: 1.5rem;
        height: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 2px solid white;
        transition: transform 0.2s;
      }
      .thumbnail-remove-btn:hover {
        transform: scale(1.1);
      }

      /* Toast Notification Styling */
      #toast-container {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .toast {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
        transform: translateX(120%);
        opacity: 0;
        transition: transform 0.4s ease-out, opacity 0.4s ease-out;
      }
      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }
      .toast-icon {
        flex-shrink: 0;
        width: 1.5rem;
        height: 1.5rem;
      }
      .toast-success {
        background-color: #ecfdf5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }
      .toast-error {
        background-color: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }
      .toast-info {
        background-color: #eff6ff;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }
    </style>
  </head>
  <body class="flex flex-col min-h-screen bg-slate-100">
    <div id="toast-container"></div>

    <main
      id="main-container"
      class="flex-grow flex flex-col items-center justify-center p-4"
    >
      <div class="w-full max-w-md relative">
        <!-- Verification Form -->
        <div
          id="verificationContainer"
          class="form-container p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-xl"
        >
          <div class="text-center">
            <h1 class="text-2xl font-bold text-gray-800">
              ប្រព័ន្ធសុំច្បាប់ស្វ័យប្រវត្ត
            </h1>
            <p class="mt-2 text-sm text-gray-500">ឧស្សាហកម្មឌីជីថល</p>
          </div>
          <form id="verificationForm">
            <label for="employeeIdInput" class="text-sm font-bold text-gray-700"
              >អត្តលេខ</label
            >
            <input
              id="employeeIdInput"
              type="text"
              required
              class="w-full px-4 py-3 mt-2 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow"
            />
            <button
              id="verifyButton"
              type="submit"
              class="w-full flex justify-center items-center px-4 py-3 mt-4 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-blue-400 transition-all duration-300 transform hover:scale-105"
            >
              <span id="verifyButtonText">ផ្ទៀងផ្ទាត់</span>
              <div id="verifyLoader" class="loader hidden ml-3"></div>
            </button>
          </form>
        </div>

        <!-- Admin Login Form -->
        <div
          id="adminLoginContainer"
          class="form-container absolute top-0 left-0 w-full hidden-container p-6 sm:p-8 space-y-6 bg-white rounded-2xl shadow-xl"
        >
          <div class="relative flex items-center justify-center">
            <button
              onclick="goBackToVerification()"
              class="absolute left-0 text-gray-400 hover:text-gray-700 transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="28"
                height="28"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="m12 8-4 4 4 4" />
                <path d="M16 12H8" />
              </svg>
            </button>
            <h1 class="text-2xl font-bold text-gray-800">Admin Login</h1>
          </div>
          <form id="adminLoginForm">
            <label
              for="adminPasswordInput"
              class="text-sm font-bold text-gray-700"
              >ពាក្យសម្ងាត់</label
            >
            <input
              id="adminPasswordInput"
              type="password"
              required
              class="w-full px-4 py-3 mt-2 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-shadow"
            />
            <button
              id="adminLoginButton"
              type="submit"
              class="w-full flex justify-center items-center px-4 py-3 mt-4 font-bold text-white bg-red-600 rounded-lg hover:bg-red-700 disabled:bg-red-400 transition-all duration-300 transform hover:scale-105"
            >
              <span id="adminLoginButtonText">ចូល</span>
              <div id="adminLoginLoader" class="loader hidden ml-3"></div>
            </button>
          </form>
        </div>

        <!-- Leave Request Form -->
        <div
          id="leaveRequestContainer"
          class="form-container absolute top-0 left-0 w-full hidden-container p-6 sm:p-8 space-y-4 bg-white rounded-2xl shadow-xl"
        >
          <div class="relative flex items-center justify-center">
            <button
              onclick="goBackToVerification()"
              class="absolute left-0 text-gray-400 hover:text-gray-700 transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="28"
                height="28"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="m12 8-4 4 4 4" />
                <path d="M16 12H8" />
              </svg>
            </button>
            <h1 class="text-2xl font-bold text-gray-800">
              ទម្រង់ស្នើសុំច្បាប់
            </h1>
          </div>

          <div
            id="employeeInfoContainer"
            class="flex flex-col items-center pt-2"
            style="display: none"
          >
            <img
              id="employeePhoto"
              src=""
              alt="Employee Photo"
              class="w-24 h-24 rounded-full mb-2 border-4 border-white shadow-lg object-cover"
              onerror="this.onerror=null; this.src='https://placehold.co/100x100/EFEFEF/AAAAAA&text=No+Image';"
            />
            <p
              id="employeeNameDisplay"
              class="font-bold text-xl text-gray-800"
            ></p>
          </div>

          <form
            id="leaveRequestForm"
            class="space-y-4 pt-4 border-t border-gray-200"
          >
            <input type="hidden" id="verifiedEmployeeId" />
            <input type="hidden" id="selfieImageData" />
            <input type="hidden" id="documentImageData" />
            <input type="hidden" id="paymentReceiptImageData" />
            <input
              type="hidden"
              id="numberOfDays"
              step="0.5"
              min="0.5"
              required
            />

            <div>
              <label for="leaveType" class="text-sm font-bold text-gray-700"
                >ប្រភេទច្បាប់</label
              >
              <select
                id="leaveType"
                required
                class="w-full pl-3 pr-8 py-3 mt-1 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="" disabled selected>សូមជ្រើសរើស</option>
                <option value="ច្បាប់ចេញក្រៅ">ច្បាប់ចេញក្រៅ</option>
                <option value="ច្បាប់ឈប់សម្រាក">ច្បាប់ឈប់សម្រាក</option>
                <option value="ច្បាប់ទៅផ្ទះ" disabled>ច្បាប់ទៅផ្ទះ</option>
              </select>
            </div>

            <!-- This container will be hidden initially -->
            <div id="form-details-container" class="space-y-4 hidden">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label
                    for="permissionDaysSelect"
                    class="text-sm font-bold text-gray-700"
                    >ចំនួនថ្ងៃ</label
                  >
                  <select
                    id="permissionDaysSelect"
                    class="w-full pl-3 pr-8 py-3 mt-1 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="" disabled selected>សូមជ្រើសរើស</option>
                    <option value="មួយព្រឹក">មួយព្រឹក</option>
                    <option value="មួយរសៀល">មួយរសៀល</option>
                    <option value="1">មួយថ្ងៃ</option>
                  </select>
                  <select
                    id="leaveDaysSelect"
                    class="w-full pl-3 pr-8 py-3 mt-1 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 hidden"
                  >
                    <option value="" disabled selected>សូមជ្រើសរើស</option>
                    <option value="មួយព្រឹក">មួយព្រឹក</option>
                    <option value="មួយរសៀល">មួយរសៀល</option>
                    <option value="ពេលយប់">ពេលយប់</option>
                    <option value="1">មួយថ្ងៃ</option>
                    <option value="1.5">មួយថ្ងៃកន្លះ</option>
                    <option value="2">ពីរថ្ងៃ</option>
                    <option value="2.5">ពីរថ្ងៃកន្លះ</option>
                    <option value="3">បីថ្ងៃ</option>
                    <option value="3.5">បីថ្ងៃកន្លះ</option>
                    <option value="4">បួនថ្ងៃ</option>
                    <option value="4.5">បួនថ្ងៃកន្លះ</option>
                    <option value="5">ប្រាំថ្ងៃ</option>
                  </select>
                </div>
                <div>
                  <label
                    id="startDateLabel"
                    for="startDate"
                    class="text-sm font-bold text-gray-700"
                    >ថ្ងៃចាប់ផ្តើម</label
                  >
                  <input
                    id="startDate"
                    type="date"
                    required
                    class="w-full px-4 py-3 mt-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                  <p
                    id="startDateDisplay"
                    class="text-sm text-center text-blue-600 font-semibold mt-1 h-5"
                  ></p>
                </div>
              </div>
              <div id="endDateContainer" class="hidden">
                <label for="endDate" class="text-sm font-bold text-gray-700"
                  >ថ្ងៃបញ្ចប់</label
                >
                <input
                  id="endDate"
                  type="date"
                  required
                  class="w-full px-4 py-3 mt-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <p
                  id="endDateDisplay"
                  class="text-sm text-center text-blue-600 font-semibold mt-1 h-5"
                ></p>
              </div>
              <div>
                <label for="reason" class="text-sm font-bold text-gray-700"
                  >មូលហេតុ</label
                >
                <textarea
                  id="reason"
                  rows="3"
                  required
                  class="w-full px-4 py-3 mt-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                ></textarea>
                <div
                  id="reasonSuggestions"
                  class="flex flex-wrap gap-2 mt-2"
                ></div>
              </div>

              <div id="selfieSection">
                <label id="selfieLabel" class="text-sm font-bold text-gray-700"
                  >រូបថតសាមីខ្លួន (អាចរំលងបាន)</label
                >
                <button
                  type="button"
                  id="openSelfieCameraButton"
                  class="w-full flex justify-center items-center gap-2 px-4 py-2 mt-1 font-medium text-sm text-blue-600 bg-blue-100 rounded-lg hover:bg-blue-200 transition-all"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"
                    />
                    <circle cx="12" cy="13" r="3" />
                  </svg>
                  ថតរូបសាមីខ្លួន
                </button>
                <div
                  id="selfiePreviewContainer"
                  class="mt-2 text-center hidden"
                >
                  <img
                    id="selfiePreview"
                    class="w-32 h-32 object-cover rounded-lg inline-block border-2 border-gray-300"
                  />
                  <button
                    type="button"
                    id="removeSelfiePhotoButton"
                    class="text-xs text-red-500 hover:text-red-700 mt-1"
                  >
                    លុបរូបនេះ
                  </button>
                </div>
              </div>

              <div id="documentSection" class="hidden">
                <label
                  id="documentLabel"
                  class="text-sm font-bold text-gray-700"
                  >រូបភាពឯកសារបញ្ជាក់ (អាចដាក់បាន 4សន្លឹក)</label
                >
                <p
                  id="documentDescription"
                  class="text-xs text-gray-500 mt-1 mb-2"
                >
                  ក្នុងករណីប្អូនឈឺ មានសំបុត្របញ្ជាក់ពីពេទ្យ
                  សូមប្អូនៗបង្ហាញឯកសារផ្សេងៗជាភ័ស្តុតាងដើម្បីបញ្ជាក់!
                </p>
                <div class="mt-1 grid grid-cols-2 gap-2">
                  <button
                    type="button"
                    id="openDocumentCameraButton"
                    class="w-full flex justify-center items-center gap-2 px-4 py-2 font-medium text-sm text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"
                      />
                      <circle cx="12" cy="13" r="3" />
                    </svg>
                    ថតរូបឯកសារ
                  </button>
                  <label
                    for="chooseFileButton"
                    class="w-full flex justify-center items-center gap-2 px-4 py-2 font-medium text-sm text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all cursor-pointer"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"
                      ></path>
                    </svg>
                    ជ្រើសរើសរូបភាព
                  </label>
                  <input
                    type="file"
                    id="chooseFileButton"
                    class="hidden"
                    accept="image/*"
                    multiple
                  />
                </div>
                <div
                  id="documentPreviewContainer"
                  class="mt-2 flex flex-wrap gap-2"
                >
                  <!-- Thumbnails will be generated here -->
                </div>
              </div>
            </div>

            <button
              id="submitLeaveButton"
              type="button"
              class="w-full flex justify-center items-center px-4 py-3 font-bold text-white bg-green-400 rounded-lg transition-all duration-300 transform"
              disabled
            >
              <span id="submitLeaveButtonText">ដាក់ស្នើ</span>
              <div id="submitLeaveLoader" class="loader hidden ml-3"></div>
            </button>
          </form>
        </div>

        <!-- Waiting for Approval Screen -->
        <div
          id="waitingContainer"
          class="form-container absolute top-0 left-0 w-full hidden-container p-6 sm:p-8 text-center bg-white rounded-2xl shadow-xl"
        >
          <h1 id="waitingTitle" class="text-2xl font-bold text-gray-800"></h1>
          <div id="waitingLoader" class="mt-6 flex justify-center items-center">
            <div
              class="animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent"
            ></div>
          </div>
          <p id="waitingStatusText" class="mt-4 text-gray-600 font-medium"></p>
          <div id="waitingNotice" class="mt-2 text-xs text-gray-500"></div>
          <div class="mt-6 p-4 bg-slate-50 rounded-lg text-left text-sm">
            <p>
              <strong>ID ស្នើសុំ:</strong>
              <span id="statusRequestId" class="font-mono"></span>
            </p>
            <p>
              <strong>ស្ថានភាព:</strong>
              <span id="statusText" class="font-bold"></span>
            </p>
          </div>
          <!-- Rejection Reason Display -->
          <div
            id="rejectionReasonContainer"
            class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg text-left text-sm"
          >
            <p class="font-bold text-red-700">មូលហេតុនៃការបដិសេធ:</p>
            <p
              id="rejectionReasonText"
              class="text-red-800 whitespace-pre-wrap"
            ></p>
          </div>
          <div class="mt-6 space-y-2">
            <button
              id="returnToFormButton"
              onclick="returnToLeaveForm()"
              class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-opacity"
            >
              ត្រឡប់ចូលទម្រង់សុំច្បាប់ <span id="returnTimer"></span>
            </button>
          </div>
        </div>

        <!-- Approved Receipt Container -->
        <div
          id="approvedReceiptContainer"
          class="form-container absolute top-0 left-0 w-full hidden-container p-6 bg-white rounded-2xl shadow-xl"
        >
          <div class="text-center border-b-2 border-dashed pb-4">
            <svg
              class="w-16 h-16 text-green-500 mx-auto"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-2">
              បង្កាន់ដៃសុំច្បាប់
            </h1>
            <p
              id="receiptApprovalMessage"
              class="text-sm text-gray-500 leading-relaxed"
            ></p>
          </div>
          <div class="py-4 space-y-2">
            <div class="text-center my-4">
              <img
                id="receiptEmployeePhoto"
                src=""
                alt="Employee Photo"
                class="w-20 h-20 rounded-full mx-auto border-4 border-white shadow-md object-cover"
              />
              <p
                id="receiptEmployeeName"
                class="font-bold text-lg text-gray-800 mt-2"
              ></p>
              <p class="text-sm text-gray-500">
                ID: <span id="receiptEmployeeId" class="font-mono"></span>
              </p>
            </div>
            <div class="receipt-item">
              <span class="receipt-item-label">ID ស្នើសុំ</span
              ><span
                id="receiptRequestId"
                class="receipt-item-value font-mono text-xs"
              ></span>
            </div>
            <div class="receipt-item">
              <span class="receipt-item-label">ប្រភេទច្បាប់</span
              ><span id="receiptLeaveType" class="receipt-item-value"></span>
            </div>

            <!-- DYNAMIC DATE CONTAINER -->
            <div id="receiptDateContainer"></div>

            <div class="receipt-item">
              <span class="receipt-item-label">ចំនួនថ្ងៃ</span
              ><span id="receiptNumberOfDays" class="receipt-item-value"></span>
            </div>
            <div class="pt-2">
              <span class="receipt-item-label">មូលហេតុ</span>
              <p
                id="receiptReason"
                class="text-sm text-gray-700 mt-1 bg-gray-50 p-3 rounded-md"
              ></p>
            </div>
          </div>
          <div id="receiptActions" class="pt-4 mt-4 border-t">
            <div id="receiptNoticeContainer">
              <div
                id="receiptNoticeDefault"
                class="hidden text-center text-xs text-gray-500 p-2 bg-gray-100 rounded-md"
              >
                សូមថតរូបបង្កាន់ដៃនេះទុកជាភស្តុតាង។
              </div>
              <div
                id="receiptNoticePermission"
                class="hidden text-center text-sm p-3 bg-red-100 text-red-700 rounded-md"
              >
                <p>
                  នៅពេលប្អូនត្រឡប់ចូលមកសាលាវិញ ប្អូនត្រូវចុចប៊ូតុង "បានចូលមកវិញ"
                  ដើម្បីផ្ទៀងផ្ទាត់បញ្ជាក់ថាប្អូនពិតជាបានត្រឡប់ចូលមកសាលាវិញពិតប្រាកដមែន។
                </p>
                <p class="mt-2">
                  <strong>សូមបញ្ជាក់បន្ថែម៖</strong>
                  ប្រសិនណាប្អូនបានចូលមកសាលាវិញហើយ
                  តែមិនបានផ្ទៀងផ្ទាត់បញ្ជាក់ថាប្អូនពិតជាបានត្រឡប់ចូលវិញទេ
                  ករណីបាត់ប្រាក់បៀវត្សលោកគ្រូមិនទទួលខុសត្រូវទេ។
                </p>
              </div>
            </div>
            <div
              id="receiptButtonContainer"
              class="flex flex-col items-center gap-2 mt-4"
            ></div>
            <!-- NEW: FOOTER LINK -->
            <div class="mt-6">
              <a
                href="https://t.me/MMKDaro"
                target="_blank"
                class="flex items-center justify-center gap-2 w-full px-4 py-3 bg-sky-500 text-white font-bold rounded-lg hover:bg-sky-600 transition-all transform hover:scale-105 shadow-md"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  class="text-white"
                >
                  <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.88-1.44 6.99c-.15.71-.58.89-1.18.55l-2.2-1.62-1.06 1.02c-.12.12-.22.22-.44.22l.16-2.26 4.14-3.75c.18-.16-.05-.25-.3-.1l-5.12 3.22-2.14-.67c-.72-.22-.73-.71.15-1.05l8.5-3.35c.6-.23 1.12.15.95.88z"
                  />
                </svg>
                <span>មានបញ្ហាទាក់ទងមកលោកគ្រូ</span>
              </a>
            </div>
          </div>
        </div>

        <!-- Check-in Form -->
        <div
          id="checkInContainer"
          class="form-container absolute top-0 left-0 w-full hidden-container p-6 sm:p-8 space-y-4 bg-white rounded-2xl shadow-xl"
        >
          <div class="relative flex items-center justify-center">
            <button
              onclick="showContainer('approvedReceiptContainer')"
              class="absolute left-0 text-gray-400 hover:text-gray-700 transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="28"
                height="28"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="m12 8-4 4 4 4" />
                <path d="M16 12H8" />
              </svg>
            </button>
            <h1 class="text-2xl font-bold text-gray-800">បញ្ជាក់ការចូលមកវិញ</h1>
          </div>
          <input type="hidden" id="checkInRequestId" />
          <input type="hidden" id="checkInImageData" />
          <div class="pt-4 border-t">
            <button
              type="button"
              id="openCheckInCameraButton"
              class="w-full flex justify-center items-center gap-2 px-4 py-2 font-medium text-sm text-blue-600 bg-blue-100 rounded-lg hover:bg-blue-200 transition-all"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"
                />
                <circle cx="12" cy="13" r="3" />
              </svg>
              ថតរូបសាមីខ្លួន
            </button>
            <div id="checkInPreviewContainer" class="mt-2 text-center hidden">
              <img
                id="checkInPreview"
                class="w-32 h-32 object-cover rounded-lg inline-block border-2 border-gray-300"
              />
              <button
                type="button"
                id="removeCheckInPhotoButton"
                class="text-xs text-red-500 hover:text-red-700 mt-1"
              >
                លុបរូបនេះ
              </button>
            </div>
          </div>
          <button
            id="submitCheckInButton"
            type="button"
            onclick="handleSubmitCheckIn()"
            class="w-full flex justify-center items-center px-4 py-3 font-bold text-white bg-green-400 rounded-lg transition-all duration-300 transform"
            disabled
          >
            <span id="submitCheckInButtonText">បញ្ជាក់ការចូលមកវិញ</span>
            <div id="submitCheckInLoader" class="loader hidden ml-3"></div>
          </button>
        </div>

        <!-- Admin Checked In Notice -->
        <div
          id="adminCheckedInContainer"
          class="form-container absolute top-0 left-0 w-full hidden-container p-8 text-center bg-white rounded-2xl shadow-xl"
        >
          <div
            class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100"
          >
            <svg
              class="h-10 w-10 text-blue-600"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
          <h1 class="text-xl font-bold text-gray-800 mt-4">
            ប្អូនបានចូលមកដល់សាលាវិញហើយ
          </h1>
          <p class="mt-2 text-gray-600">
            ជាករណីពិសេស លោកគ្រូ បានបញ្ជាក់ដោយផ្ទាល់។
          </p>
        </div>
      </div>
    </main>

    <!-- Generic Info/Error Modal -->
    <div
      id="infoModal"
      class="modal fixed inset-0 bg-gray-800 bg-opacity-75 h-full w-full items-center justify-center z-50 hidden"
    >
      <div
        class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-2xl bg-white"
      >
        <div class="mt-3 text-center">
          <div
            id="infoModalIcon"
            class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100"
          >
            <svg
              class="h-6 w-6 text-blue-600"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </div>
          <h3
            id="infoModalTitle"
            class="text-lg leading-6 font-medium text-gray-900 mt-4"
          >
            Notice
          </h3>
          <div class="mt-2 px-7 py-3">
            <p id="infoModalMessage" class="text-sm text-gray-600"></p>
          </div>
          <div class="flex items-center justify-center px-4 py-3">
            <button
              onclick="closeModal('infoModal')"
              class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none"
            >
              យល់ព្រម
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bank Payment Modal -->
    <div
      id="bankPaymentModal"
      class="modal fixed inset-0 bg-gray-800 bg-opacity-75 h-full w-full items-center justify-center z-50 hidden"
    >
      <div
        class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-2xl bg-white"
      >
        <div class="mt-3 text-center">
          <div
            class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-blue-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"
              />
            </svg>
          </div>
          <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">
            ជ្រើសរើសធនាគារសម្រាប់ទូទាត់
          </h3>
          <div class="mt-2 px-7 py-3">
            <p class="text-sm text-gray-600">
              1. សូមជ្រើសរើសធនាគារ និងធ្វើការទូទាត់។
            </p>
            <p class="text-sm text-gray-600">
              2. បន្ទាប់មក Upload វិក័យបត្ររបស់អ្នក។
            </p>
          </div>
          <div class="mt-4 px-4 py-3 space-y-3">
            <a
              href="https://pay.ababank.com/1ckiRKqFNHvUFGxk8"
              target="_blank"
              class="bank-link flex items-center justify-start p-3 font-bold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all"
            >
              <img
                id="abaLogo"
                src="https://i.postimg.cc/5yzwMz7m/e233f5b0c5a358449398f202b03f063a.jpg"
                alt="ABA Bank"
                class="w-10 h-10 mr-4 object-contain"
              />
              <span>ធនាគារ អេប៊ីអេ</span>
            </a>
            <a
              href="https://acledabank.com.kh/acleda?payment_data=qWY5B2SAUfIhLblxzOtfux3xJRdAPs8G9Uek1toYoIRXbWjNLVWC597Hbca7KgFQA+Wmw+1LygHTsFYyOEGuPgAw8VrurRMQM70tDwmLXUcBhuNWzaezJWgSgDhQzNexaY2a15FNhRSFC8+P06h9wb8WAVGpeAdL2NOTK3IQsZo/sfR58gHWTXeNcRe9JRIEEERKCQlh9a71G2ZzF8YNsRE8m/htoE4/X/sAQIvzTjT2Ry9zKw7COfVf4uAB+eiE81FcOQP5eOkETSk5vayk5w==&key=khqr"
              target="_blank"
              class="bank-link flex items-center justify-start p-3 font-bold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all"
            >
              <img
                id="acledaLogo"
                src="https://i.postimg.cc/yx3TYtdc/OIP.webp"
                alt="ACLEDA Bank"
                class="w-10 h-10 mr-4 object-contain"
              />
              <span>ធនាគារ អេស៊ីលីដា</span>
            </a>
            <a
              href="https://prasacmb.page.link/1fxGxujf5oaQGKTAA"
              target="_blank"
              class="bank-link flex items-center justify-start p-3 font-bold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all"
            >
              <img
                id="kbprasacLogo"
                src="https://i.postimg.cc/RC2kQzcr/sfdgfdgdfg.jpg"
                alt="KB PRASAC Bank"
                class="w-10 h-10 mr-4 object-contain"
              />
              <span>ធនាគារ ខេប៊ីប្រាសាក់</span>
            </a>
            <a
              href="https://amret.onelink.me/dRe0/iplghvvp?mode=KHQR&module=KHQR&code=2508131631580aa543ba4f8f4ea2a6e941daa7d639e5"
              target="_blank"
              class="bank-link flex items-center justify-start p-3 font-bold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all"
            >
              <img
                id="amretLogo"
                src="https://i.postimg.cc/4NtrWF5Y/512x512bb-1.jpg"
                alt="Amret MFI"
                class="w-10 h-10 mr-4 object-contain"
              />
              <span>គ្រឹះស្ថាន អម្រឹត</span>
            </a>
          </div>

          <div class="px-4 py-3 space-y-2 border-t">
            <button
              type="button"
              id="showQrButton"
              class="w-full flex justify-center items-center gap-2 px-4 py-2 font-medium text-sm text-white bg-gray-800 rounded-lg hover:bg-black transition-all"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <path d="M7 7h3v3H7zM14 7h3v3h-3zM14 14h3v3h-3zM7 14h3v3H7z" />
              </svg>
              <span>ទូទាត់តាមធនាគាផ្សេង</span>
            </button>
            <label
              id="uploadReceiptLabel"
              for="paymentReceiptUpload"
              class="w-full flex justify-center items-center gap-2 px-4 py-2 font-medium text-sm text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-all cursor-pointer"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z"
                  clip-rule="evenodd"
                />
              </svg>
              <span>Upload វិក័យបត្រ</span>
            </label>
            <input
              type="file"
              id="paymentReceiptUpload"
              class="hidden"
              accept="image/*"
            />
          </div>

          <div class="px-4 py-3 space-y-2">
            <button
              id="bankPaymentPaidButton"
              onclick="finalizeSubmission()"
              class="w-full px-4 py-2 bg-gray-400 text-white text-base font-medium rounded-md shadow-sm cursor-not-allowed"
              disabled
            >
              បានទូទាត់រួច
            </button>
            <button
              onclick="closeModal('bankPaymentModal')"
              class="mt-2 text-sm text-gray-500 hover:text-gray-700"
            >
              បោះបង់
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- QR Code Modal -->
    <div
      id="qrCodeModal"
      class="modal fixed inset-0 bg-gray-800 bg-opacity-75 h-full w-full items-center justify-center z-50 hidden"
    >
      <div
        class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-2xl bg-white text-center"
      >
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          ស្កេនដើម្បីបង់ប្រាក់
        </h3>
        <div class="mt-4">
          <img
            id="qrCodeImage"
            src="https://i.postimg.cc/sxhMZcyk/photo-2025-08-15-00-16-54.jpg"
            alt="Payment QR Code"
            class="w-full h-auto rounded-lg"
          />
        </div>
        <div class="mt-4">
          <button
            onclick="closeModal('qrCodeModal')"
            class="px-4 py-2 bg-gray-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none"
          >
            បិទ
          </button>
        </div>
      </div>
    </div>

    <div
      id="camera-modal"
      class="fixed inset-0 bg-black z-50 flex items-center justify-center hidden"
    >
      <div class="relative w-full h-full">
        <video id="camera-stream" autoplay playsinline></video>
        <canvas id="camera-canvas" class="hidden"></canvas>
        <div
          id="camera-message"
          class="absolute top-5 left-1/2 -translate-x-1/2 bg-black bg-opacity-50 text-white text-center p-2 rounded-lg z-20"
        ></div>
      </div>
      <div class="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-4 z-20">
        <button
          id="capture-button"
          class="p-4 bg-blue-600 rounded-full text-white hover:bg-blue-700 shadow-lg"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="3" />
            <path
              d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"
            />
          </svg>
        </button>
        <button
          id="switch-camera-button"
          class="p-4 bg-gray-500 bg-opacity-80 rounded-full text-white hover:bg-gray-600 shadow-lg"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M11 19H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5" />
            <path d="M13 5h7a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-5" />
            <path d="m17 12-4-4 4-4" />
            <path d="m7 12 4 4-4 4" />
          </svg>
        </button>
        <button
          id="close-camera-button"
          class="p-4 bg-red-600 rounded-full text-white hover:bg-red-700 shadow-lg"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>
    </div>

    <footer class="w-full text-center text-gray-500 text-xs py-4">
      <p>2025@MMKDARO || Version 31.1.3</p>
    </footer>

    <script>
      // --- SCRIPT CONTENT HAS BEEN UPDATED FOR PERFORMANCE & UI LOGIC ---
      // --- PLEASE REPLACE THE ENTIRE SCRIPT SECTION ---

      // --- GLOBAL STATE ---
      let currentEmployeeName = "";
      let currentEmployeePhotoUrl = "";
      let statusCheckTimeout = null;
      let returnButtonTimer = null;
      let currentRequestId = null;
      let currentRejectionReason = ""; // Store rejection reason for update logic
      let cameraStream = null;
      let currentFacingMode = "user";
      let captureTarget = "";
      let documentImages = [];
      let modelsLoaded = false;
      let pollCount = 0;
      let pendingSubmissionDetails = null;
      let bankPaymentTimer = null;
      let adminCheckedInPoller = null;

      // --- NEW: Map for day text to numeric value ---
      const dayValueMap = {
        មួយព្រឹក: 0.5,
        មួយរសៀល: 0.5,
        ពេលយប់: 0.5,
        1: 1,
        1.5: 1.5,
        2: 2,
        2.5: 2.5,
        3: 3,
        3.5: 3.5,
        4: 4,
        4.5: 4.5,
        5: 5,
      };

      // --- DOM ELEMENT REFERENCES ---
      const mainContainer = document.getElementById("main-container");
      const allContainers = document.querySelectorAll(".form-container");
      const employeeIdInput = document.getElementById("employeeIdInput");
      const verifiedEmployeeId = document.getElementById("verifiedEmployeeId");
      const leaveRequestForm = document.getElementById("leaveRequestForm");
      const numberOfDaysInput = document.getElementById("numberOfDays");
      const permissionDaysSelect = document.getElementById(
        "permissionDaysSelect"
      );
      const leaveDaysSelect = document.getElementById("leaveDaysSelect");
      const startDateInput = document.getElementById("startDate");
      const endDateInput = document.getElementById("endDate");
      const startDateLabel = document.getElementById("startDateLabel");
      const endDateContainer = document.getElementById("endDateContainer");
      const employeeInfoContainer = document.getElementById(
        "employeeInfoContainer"
      );
      const employeePhoto = document.getElementById("employeePhoto");
      const employeeNameDisplay = document.getElementById(
        "employeeNameDisplay"
      );
      const leaveTypeSelect = document.getElementById("leaveType");
      const reasonInput = document.getElementById("reason");
      const submitLeaveButton = document.getElementById("submitLeaveButton");
      const submitButtonText = document.getElementById("submitLeaveButtonText");
      const selfieImageDataInput = document.getElementById("selfieImageData");
      const selfiePreviewContainer = document.getElementById(
        "selfiePreviewContainer"
      );
      const selfiePreview = document.getElementById("selfiePreview");
      const documentImageDataInput =
        document.getElementById("documentImageData");
      const documentPreviewContainer = document.getElementById(
        "documentPreviewContainer"
      );
      const chooseFileButton = document.getElementById("chooseFileButton");
      const cameraModal = document.getElementById("camera-modal");
      const videoElement = document.getElementById("camera-stream");
      const canvasElement = document.getElementById("camera-canvas");
      const captureButton = document.getElementById("capture-button");
      const cameraMessage = document.getElementById("camera-message");
      const paymentReceiptUpload = document.getElementById(
        "paymentReceiptUpload"
      );
      const bankPaymentPaidButton = document.getElementById(
        "bankPaymentPaidButton"
      );
      const uploadReceiptLabel = document.getElementById("uploadReceiptLabel");
      const selfieLabel = document.getElementById("selfieLabel");
      const documentLabel = document.getElementById("documentLabel");
      const documentDescription = document.getElementById(
        "documentDescription"
      );
      const formDetailsContainer = document.getElementById(
        "form-details-container"
      );

      // --- INITIALIZATION ---
      async function loadModels() {
        try {
          showToast("កំពុងផ្ទុកទិន្នន័យសម្គាល់...", "info");
          const MODEL_URL =
            "https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights";
          await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
          ]);
          modelsLoaded = true;
          showToast("ទិន្នន័យសម្គាល់បានផ្ទុករួចរាល់", "success");
        } catch (error) {
          console.error("Error loading face detection models:", error);
          showToast(
            "Error loading models. Face comparison may not work.",
            "error"
          );
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadModels();

        const approvedReceiptData = localStorage.getItem("approvedReceiptData");
        const pendingRequestId = localStorage.getItem("pendingRequestId");
        const pendingEmployeeId = localStorage.getItem("pendingEmployeeId");

        if (approvedReceiptData) {
          const data = JSON.parse(approvedReceiptData);
          currentEmployeeName = data.currentEmployeeName;
          currentEmployeePhotoUrl = data.currentEmployeePhotoUrl;
          populateAndShowReceipt(data.requestId, data.details);
        } else if (pendingRequestId && pendingEmployeeId) {
          // Use the consolidated function on page load for faster resume
          google.script.run
            .withSuccessHandler((response) => {
              if (response.verificationStatus === "success") {
                resumePendingState(
                  pendingRequestId,
                  pendingEmployeeId,
                  response.employeeInfo,
                  response.leaveStatus
                );
              } else {
                showToast(
                  "Could not restore session: " + response.message,
                  "error"
                );
                goBackToVerification();
              }
            })
            .withFailureHandler((error) => {
              showToast(
                "Server error on session restore: " + error.message,
                "error"
              );
              goBackToVerification();
            })
            .verifyEmployeeAndGetStatus(pendingEmployeeId);
        } else {
          showContainer("verificationContainer");
        }

        initializeForm();

        document
          .getElementById("verificationForm")
          .addEventListener("submit", handleVerificationSubmit);
        document
          .getElementById("adminLoginForm")
          .addEventListener("submit", handleAdminLoginSubmit);
        submitLeaveButton.addEventListener("click", handleLeaveSubmit);

        // Camera listeners
        document
          .getElementById("openSelfieCameraButton")
          .addEventListener("click", () => openCameraWithNotice("selfie"));
        document
          .getElementById("openDocumentCameraButton")
          .addEventListener("click", () => openCameraWithNotice("document"));
        document
          .getElementById("openCheckInCameraButton")
          .addEventListener("click", () => openCameraWithNotice("check-in"));
        document
          .getElementById("close-camera-button")
          .addEventListener("click", closeCamera);
        captureButton.addEventListener("click", capturePhoto);
        document
          .getElementById("removeSelfiePhotoButton")
          .addEventListener("click", removeSelfiePhoto);
        document
          .getElementById("switch-camera-button")
          .addEventListener("click", switchCamera);
        chooseFileButton.addEventListener("change", handleFileSelect);
        document
          .getElementById("removeCheckInPhotoButton")
          .addEventListener("click", removeCheckInPhoto);

        // Form listeners
        const formFields = [
          leaveTypeSelect,
          startDateInput,
          endDateInput,
          reasonInput,
          permissionDaysSelect,
          leaveDaysSelect,
        ];
        formFields.forEach((field) =>
          field.addEventListener("input", checkFormValidity)
        );
        leaveTypeSelect.addEventListener("change", handleLeaveTypeChange);
        reasonInput.addEventListener("input", displayReasonSuggestions);
        permissionDaysSelect.addEventListener("change", handleDaysChange);
        leaveDaysSelect.addEventListener("change", handleDaysChange);
        startDateInput.addEventListener("change", calculateEndDate);

        // Bank Payment Listeners
        const bankLinks = document.querySelectorAll(".bank-link");
        bankLinks.forEach((link) => {
          link.addEventListener("click", startBankPaymentTimer);
        });

        // Payment Receipt Listener
        paymentReceiptUpload.addEventListener("change", handleReceiptUpload);

        // QR Code Button Listener
        document
          .getElementById("showQrButton")
          .addEventListener("click", () => openModal("qrCodeModal"));
      });

      // --- UI & STATE MANAGEMENT ---
      const reasonSuggestions = {
        ច្បាប់ឈប់សម្រាក: [
          "ឈឺ(មិនស្រួលខ្លួន)",
          "ឈឺក្បាល ចុះពោះ",
          "សម្រាកព្យាបាលនៅពេទ្យ",
        ],
        ច្បាប់ចេញក្រៅ: [
          "ទៅធនាគារ",
          "ទៅផ្សារ",
          "ទៅកាត់សក់",
          "ទៅផ្សារទិញអីវ៉ាន់",
          "ទៅពេទ្យនៅភ្នំពេញ",
          "ទៅភ្នំពេញទិញអីវ៉ាន់",
        ],
      };

      function displayReasonSuggestions() {
        const suggestionsContainer =
          document.getElementById("reasonSuggestions");
        const currentLeaveType = leaveTypeSelect.value;
        suggestionsContainer.innerHTML = "";
        const suggestions = reasonSuggestions[currentLeaveType] || [];
        suggestions.forEach((suggestion) => {
          const button = document.createElement("button");
          button.type = "button";
          button.textContent = suggestion;
          button.className =
            "suggestion-btn px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-xs hover:bg-blue-500 hover:text-white transition-colors";
          button.onclick = () => selectReasonSuggestion(suggestion);
          suggestionsContainer.appendChild(button);
        });
      }

      function selectReasonSuggestion(suggestion) {
        reasonInput.value = suggestion;
        document.getElementById("reasonSuggestions").innerHTML = "";
        checkFormValidity();
      }

      function handleLeaveTypeChange() {
        const selectedType = leaveTypeSelect.value;
        const isPermission = selectedType === "ច្បាប់ចេញក្រៅ";
        const isLeave = selectedType === "ច្បាប់ឈប់សម្រាក";

        if (selectedType) {
          formDetailsContainer.classList.remove("hidden");
        } else {
          formDetailsContainer.classList.add("hidden");
        }

        document
          .getElementById("documentSection")
          .classList.toggle("hidden", !isLeave);
        permissionDaysSelect.classList.toggle("hidden", !isPermission);
        leaveDaysSelect.classList.toggle("hidden", !isLeave);

        // Reset day selection when type changes
        permissionDaysSelect.value = "";
        leaveDaysSelect.value = "";
        numberOfDaysInput.value = "";
        endDateContainer.classList.add("hidden");
        startDateLabel.textContent = "កាលបរិច្ឆេទ";

        if (isLeave) {
          // Update text for "ច្បាប់ឈប់សម្រាក"
          selfieLabel.textContent = "ផ្ទៀងផ្ទាត់អត្តសញ្ញាណដោយផ្ទៃមុខ (ចាំបាច់)";
          documentLabel.textContent = "រូបភាពឯកសារបញ្ជាក់ (ប្រសិនបើមាន)";
          documentDescription.textContent =
            "ក្នុងករណីប្អូនឈឺសម្រាកច្រើនថ្ងៃ ប្រសិនមានសំបុត្របញ្ជាក់ពីពេទ្យ សូមប្អូនៗបង្ហាញឯកសារផ្សេងៗជាភ័ស្តុតាងដើម្បីបញ្ជាក់! (អាចរូបភាពឯកសារបាន ៤សន្លឹក)";
          removeDocumentPhoto(); // Clear any existing photos if switching
        } else {
          // Revert text for "ច្បាប់ចេញក្រៅ" or default
          selfieLabel.textContent = "រូបថតសាមីខ្លួន (អាចរំលងបាន)";
        }

        displayReasonSuggestions();
        checkFormValidity(); // Re-check validity after change
      }

      function handleDaysChange(event) {
        const selectedText = event.target.value;
        const numericValue =
          dayValueMap[selectedText] || parseFloat(selectedText) || 0;
        numberOfDaysInput.value = numericValue;

        if (numericValue <= 1) {
          endDateContainer.classList.add("hidden");
          startDateLabel.textContent = "កាលបរិច្ឆេទ";
        } else {
          endDateContainer.classList.remove("hidden");
          startDateLabel.textContent = "ថ្ងៃចាប់ផ្តើម";
        }
        calculateEndDate();
      }

      function checkFormValidity() {
        let isFormValid =
          leaveTypeSelect.value.trim() !== "" &&
          parseFloat(numberOfDaysInput.value) > 0 &&
          startDateInput.value.trim() !== "" &&
          endDateInput.value.trim() !== "" &&
          reasonInput.value.trim() !== "";

        if (leaveTypeSelect.value === "ច្បាប់ឈប់សម្រាក") {
          if (selfieImageDataInput.value.trim() === "") {
            isFormValid = false; // Selfie is required for this type
          }
        }

        submitLeaveButton.disabled = !isFormValid;
        submitLeaveButton.classList.toggle("bg-green-600", isFormValid);
        submitLeaveButton.classList.toggle("hover:bg-green-700", isFormValid);
        submitLeaveButton.classList.toggle("hover:scale-105", isFormValid);
        submitLeaveButton.classList.toggle("bg-green-400", !isFormValid);
      }

      function initializeForm() {
        const today = new Date().toISOString().split("T")[0];
        startDateInput.value = today;
        endDateInput.value = today;
        startDateInput.min = today;

        leaveTypeSelect.value = "";
        permissionDaysSelect.value = "";
        leaveDaysSelect.value = "";
        numberOfDaysInput.value = "";

        handleLeaveTypeChange();
      }

      function calculateEndDate() {
        const days = parseFloat(numberOfDaysInput.value);
        if (!startDateInput.value || isNaN(days) || days <= 0) {
          endDateInput.value = startDateInput.value;
          updateDateDisplays();
          checkFormValidity();
          return;
        }

        const startDate = new Date(startDateInput.value);

        if (days <= 1) {
          endDateInput.value = startDateInput.value;
        } else {
          const endDate = new Date(startDate);
          endDate.setDate(startDate.getDate() + Math.ceil(days) - 1);
          endDateInput.value = endDate.toISOString().split("T")[0];
        }
        endDateInput.min = startDateInput.value;

        updateDateDisplays();
        checkFormValidity();
      }

      function updateDateDisplays() {
        const startDateDisplay = document.getElementById("startDateDisplay");
        const endDateDisplay = document.getElementById("endDateDisplay");

        if (startDateInput.value) {
          startDateDisplay.textContent = formatDateToKhmer(
            startDateInput.value
          );
        } else {
          startDateDisplay.textContent = "";
        }

        if (endDateContainer.classList.contains("hidden")) {
          endDateDisplay.textContent = "";
        } else if (endDateInput.value) {
          endDateDisplay.textContent = formatDateToKhmer(endDateInput.value);
        } else {
          endDateDisplay.textContent = "";
        }
      }

      function showContainer(containerIdToShow) {
        allContainers.forEach((container) => {
          if (container.id === containerIdToShow) {
            container.classList.remove("hidden-container");
            container.classList.add("visible-container");
          } else {
            container.classList.add("hidden-container");
            container.classList.remove("visible-container");
          }
        });

        if (
          containerIdToShow === "verificationContainer" ||
          containerIdToShow === "adminLoginContainer"
        ) {
          mainContainer.classList.remove("justify-start", "pt-8");
          mainContainer.classList.add("justify-center");
        } else {
          mainContainer.classList.remove("justify-center");
          mainContainer.classList.add("justify-start", "pt-8");
        }
      }

      function stopAllPollers() {
        if (statusCheckTimeout) clearTimeout(statusCheckTimeout);
        if (adminCheckedInPoller) clearInterval(adminCheckedInPoller);
        statusCheckTimeout = null;
        adminCheckedInPoller = null;
      }

      function goBackToVerification() {
        stopAllPollers();
        if (returnButtonTimer) clearInterval(returnButtonTimer);
        closeCamera();
        localStorage.clear();

        currentRequestId = null;
        currentEmployeeName = "";
        currentEmployeePhotoUrl = "";
        currentRejectionReason = ""; // Reset rejection reason

        submitButtonText.textContent = "ដាក់ស្នើ";
        showContainer("verificationContainer");
        leaveRequestForm.reset();
        employeeIdInput.value = "";
        employeeInfoContainer.style.display = "none";

        initializeForm();
      }

      function updateStatusDisplay(status, leaveType, reason = "") {
        const statusTextEl = document.getElementById("statusText");
        const waitingTitle = document.getElementById("waitingTitle");
        const waitingStatusText = document.getElementById("waitingStatusText");
        const returnBtn = document.getElementById("returnToFormButton");
        const waitingLoader = document.getElementById("waitingLoader");
        const waitingNotice = document.getElementById("waitingNotice");
        const rejectionReasonContainer = document.getElementById(
          "rejectionReasonContainer"
        );
        const rejectionReasonText = document.getElementById(
          "rejectionReasonText"
        );

        rejectionReasonContainer.classList.add("hidden"); // Hide by default

        if (status === "Not Found") {
          waitingTitle.textContent = "រកមិនឃើញសំណើ";
          waitingStatusText.textContent =
            "សំណើរបស់អ្នកត្រូវបានលុប ឬ រកមិនឃើញ។ កំពុងត្រឡប់ទៅទំព័រដើម...";
          waitingLoader.style.display = "none";
          returnBtn.style.display = "none";
          showToast(
            "រកមិនឃើញសំណើទេ។ ត្រឡប់ទៅទំព័រដើមក្នុងរយៈពេល 2 វិនាទី។",
            "error"
          );
          setTimeout(() => {
            goBackToVerification();
          }, 2000);
          return;
        }

        const statusMap = {
          Pending: {
            text: "សូមរង់ចាំការអនុម័ត",
            title: "បានដាក់ស្នើ",
            color: "status-pending",
            statusMsg: "កំពុងរង់ចាំការសម្រេច...",
          },
          Approved: {
            text: "បានអនុម័ត",
            title: "គណៈគ្រប់គ្រងបានយល់ព្រម",
            color: "status-approved",
            statusMsg: "សំណើរបស់អ្នកត្រូវបានយល់ព្រម។",
          },
          Rejected: {
            text: "បដិសេធ",
            title: "សំណើត្រូវបានបដិសេធ",
            color: "status-rejected",
            statusMsg: "សូមត្រឡប់ទៅកែសម្រួលសំណើរបស់អ្នក។",
          },
        };
        const currentStatus = statusMap[status] || {
          text: status,
          title: "Unknown Status",
          color: "",
          statusMsg: "",
        };

        statusTextEl.textContent = currentStatus.text;
        waitingTitle.textContent = currentStatus.title;
        waitingStatusText.textContent = currentStatus.statusMsg;
        statusTextEl.className = `font-bold ${currentStatus.color}`;

        waitingLoader.style.display = "none";
        returnBtn.style.display = "none";
        waitingNotice.classList.add("hidden");

        if (status === "Approved" || status === "Rejected") {
          if (returnButtonTimer) clearInterval(returnButtonTimer);
          if (status === "Approved") {
            stopAllPollers();
            const requestId = localStorage.getItem("pendingRequestId");
            if (!requestId) {
              showToast("Could not find request ID to show receipt.", "error");
              goBackToVerification();
              return;
            }

            setTimeout(() => {
              google.script.run
                .withFailureHandler((error) => {
                  showToast(
                    `Error loading receipt details: ${error.message}`,
                    "error"
                  );
                  console.error("getLeaveRequestDetails failed:", error);
                })
                .withSuccessHandler((response) => {
                  if (response.status === "success") {
                    populateAndShowReceipt(requestId, response.data);
                  } else {
                    showToast(
                      `Could not load receipt: ${response.message}`,
                      "error"
                    );
                    console.error(
                      "getLeaveRequestDetails returned error:",
                      response.message
                    );
                  }
                })
                .getLeaveRequestDetails(requestId);
            }, 500);
          } else {
            // Rejected
            if (reason) {
              rejectionReasonText.textContent = reason;
              rejectionReasonContainer.classList.remove("hidden");
            }
            if (leaveType === "ច្បាប់ចេញក្រៅ") {
              waitingNotice.innerHTML = `<p class="text-red-600 font-bold">ប្អូនសុំច្បាប់ចេញក្រៅត្រូវមកសុំដោយផ្ទាល់នៅការិយាល័យអគារ B(DI)។<br>ប្អូន ត្រូវមកសុំអនុញ្ញាតពីលោកគ្រូ ឬរដ្ឋបាល។</p>`;
              waitingNotice.classList.remove("hidden");
            }
            stopAllPollers();
            localStorage.removeItem("pendingRequestId");
            localStorage.removeItem("pendingEmployeeId");
            returnBtn.style.display = "block";
            returnBtn.disabled = false;
            returnBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
            returnBtn.classList.add("bg-gray-600", "hover:bg-gray-700");
            document.getElementById("returnTimer").textContent = "";
          }
        } else if (status === "Pending") {
          waitingLoader.style.display = "flex";
          waitingNotice.textContent =
            "សូមប្អូនៗរង់ចាំប្រហែលចន្លោះ ១នាទី ទៅ ៥នាទី។ សូមកុំចាកចេញពីប្រព័ន្ធ សូមរង់ចាំរហូតទទួលបានបង្កាន់ដៃ។";
          waitingNotice.classList.remove("hidden");
          returnBtn.style.display = "block";
        }
      }

      function formatDateToKhmer(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        const khmerNumerals = [
          "០",
          "១",
          "២",
          "៣",
          "៤",
          "៥",
          "៦",
          "៧",
          "៨",
          "៩",
        ];
        const khmerMonths = [
          "មករា",
          "កុម្ភៈ",
          "មីនា",
          "មេសា",
          "ឧសភា",
          "មិថុនា",
          "កក្កដា",
          "សីហា",
          "កញ្ញា",
          "តុលា",
          "វិច្ឆិកា",
          "ធ្នូ",
        ];
        const toKhmerNumeral = (numStr) =>
          String(numStr)
            .split("")
            .map((digit) => khmerNumerals[parseInt(digit)] || digit)
            .join("");
        const day = toKhmerNumeral(String(date.getDate()).padStart(2, "0"));
        const month = khmerMonths[date.getMonth()];
        const year = toKhmerNumeral(date.getFullYear());
        return `${day}-${month}-${year}`;
      }

      function populateAndShowReceipt(requestId, details) {
        let approverDisplay = details.approver || "គណៈគ្រប់គ្រង";
        let approvalMessageHTML = `អនុម័តដោយ <strong>${approverDisplay}</strong>`;
        if (details.approvalTimestamp) {
          const approvalDate = new Date(details.approvalTimestamp);
          const timeString = approvalDate.toLocaleTimeString("en-GB", {
            hour: "2-digit",
            minute: "2-digit",
          });
          approvalMessageHTML += `<br><span class="text-xs text-gray-500">វេលាម៉ោង ${timeString}, ${formatDateToKhmer(
            details.approvalTimestamp
          )}</span>`;
        }
        document.getElementById("receiptApprovalMessage").innerHTML =
          approvalMessageHTML;

        document.getElementById("receiptEmployeeName").textContent =
          currentEmployeeName;
        document.getElementById("receiptEmployeeId").textContent =
          details.employeeId;
        document.getElementById("receiptEmployeePhoto").src =
          currentEmployeePhotoUrl;
        document.getElementById("receiptRequestId").textContent = requestId;
        document.getElementById("receiptLeaveType").textContent =
          details.leaveType;
        document.getElementById(
          "receiptNumberOfDays"
        ).textContent = `${details.numberOfDays}`;
        document.getElementById("receiptReason").textContent = details.reason;

        // DYNAMICALLY RENDER DATE INFO
        const dateContainer = document.getElementById("receiptDateContainer");
        const numericDays =
          dayValueMap[details.numberOfDays] ||
          parseFloat(details.numberOfDays) ||
          0;

        if (numericDays > 1) {
          dateContainer.innerHTML = `
                    <div class="receipt-item"><span class="receipt-item-label">ថ្ងៃចាប់ផ្តើម</span><span class="receipt-item-value">${formatDateToKhmer(
                      details.startDate
                    )}</span></div>
                    <div class="receipt-item"><span class="receipt-item-label">ថ្ងៃបញ្ចប់</span><span class="receipt-item-value">${formatDateToKhmer(
                      details.endDate
                    )}</span></div>
                `;
        } else {
          dateContainer.innerHTML = `<div class="receipt-item"><span class="receipt-item-label">កាលបរិច្ឆេទ</span><span class="receipt-item-value">${formatDateToKhmer(
            details.startDate
          )}</span></div>`;
        }

        const noticeDefault = document.getElementById("receiptNoticeDefault");
        const noticePermission = document.getElementById(
          "receiptNoticePermission"
        );
        const receiptButtonContainer = document.getElementById(
          "receiptButtonContainer"
        );
        receiptButtonContainer.innerHTML = "";

        if (
          details.leaveType === "ច្បាប់ចេញក្រៅ" &&
          !details.checkInTimestamp
        ) {
          noticeDefault.classList.add("hidden");
          noticePermission.classList.remove("hidden");

          const downloadButton = document.createElement("button");
          downloadButton.innerHTML = "ទាញយកបង្កាន់ដៃ";
          downloadButton.className =
            "w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 mb-2 transition-colors";
          downloadButton.onclick = () => downloadReceipt(requestId);
          receiptButtonContainer.appendChild(downloadButton);

          const checkInButton = document.createElement("button");
          checkInButton.textContent = "បានចូលមកវិញ";
          checkInButton.className =
            "w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors";
          checkInButton.onclick = () => showCheckInForm(requestId);
          receiptButtonContainer.appendChild(checkInButton);

          // Start polling for admin check-in
          startAdminCheckInPoller(requestId);
        } else {
          noticeDefault.classList.remove("hidden");
          noticePermission.classList.add("hidden");

          const reviewedButton = document.createElement("button");
          reviewedButton.textContent = "បានពិនិត្យ";
          reviewedButton.className =
            "w-full px-4 py-3 font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-all";
          reviewedButton.onclick = handleReviewAndExit;
          receiptButtonContainer.appendChild(reviewedButton);
        }

        const receiptDataToStore = {
          requestId,
          details,
          currentEmployeeName,
          currentEmployeePhotoUrl,
        };
        localStorage.setItem(
          "approvedReceiptData",
          JSON.stringify(receiptDataToStore)
        );
        localStorage.removeItem("pendingRequestId");
        localStorage.removeItem("pendingEmployeeId");

        showContainer("approvedReceiptContainer");
      }

      function handleReviewAndExit() {
        localStorage.removeItem("approvedReceiptData");
        goBackToVerification();
      }

      function downloadReceipt(requestId) {
        const receiptElement = document.getElementById(
          "approvedReceiptContainer"
        );
        showToast("កំពុងរៀបចំទាញយក...", "info");
        html2canvas(receiptElement, {
          scale: 2, // Higher scale for better quality
          useCORS: true, // Important for external images
        })
          .then((canvas) => {
            const link = document.createElement("a");
            link.download = `Leave_Receipt_${requestId}.jpg`;
            link.href = canvas.toDataURL("image/jpeg", 0.9);
            link.click();
          })
          .catch((err) => {
            console.error("Error generating receipt image:", err);
            showToast("Error creating receipt image.", "error");
          });
      }

      function returnToLeaveForm() {
        if (returnButtonTimer) clearInterval(returnButtonTimer);
        stopAllPollers();
        const requestId =
          document.getElementById("statusRequestId").textContent;
        google.script.run
          .withSuccessHandler((response) => {
            if (response.status === "success") {
              const { data } = response;
              leaveTypeSelect.value = data.leaveType;
              startDateInput.value = data.startDate;
              endDateInput.value = data.endDate;

              const isPermission = data.leaveType === "ច្បាប់ចេញក្រៅ";
              const correctSelect = isPermission
                ? permissionDaysSelect
                : leaveDaysSelect;
              correctSelect.value = data.numberOfDays;

              const numericValue =
                dayValueMap[data.numberOfDays] ||
                parseFloat(data.numberOfDays) ||
                0;
              numberOfDaysInput.value = numericValue;

              reasonInput.value = data.reason;
              currentRequestId = requestId; // Set for update mode
              submitButtonText.textContent = "ធ្វើបច្ចុប្បន្នភាព";

              if (data.selfiePhotoUrl) {
                selfiePreview.src = data.selfiePhotoUrl;
                selfiePreviewContainer.classList.remove("hidden");
                selfieImageDataInput.value = data.selfiePhotoUrl;
              } else {
                removeSelfiePhoto();
              }

              if (data.documentPhotoUrl) {
                try {
                  documentImages = JSON.parse(data.documentPhotoUrl);
                } catch (e) {
                  documentImages = [data.documentPhotoUrl];
                }
                renderDocumentPreviews();
              } else {
                removeDocumentPhoto();
              }

              handleLeaveTypeChange();
              showContainer("leaveRequestContainer");
            } else {
              showToast(`Error fetching details: ${response.message}`, "error");
            }
          })
          .withFailureHandler((error) =>
            showToast(`Error: ${error.message}`, "error")
          )
          .getLeaveRequestDetails(requestId);
      }

      function resumePendingState(
        requestId,
        employeeId,
        employeeInfo,
        leaveStatus
      ) {
        currentRequestId = requestId;
        currentEmployeeName = employeeInfo.name;
        currentEmployeePhotoUrl = employeeInfo.photoUrl;

        // Store rejection reason if applicable
        if (leaveStatus.status === "Rejected") {
          currentRejectionReason = leaveStatus.reason;
        }

        // Set up common UI elements
        employeePhoto.src =
          employeeInfo.photoUrl ||
          "https://placehold.co/100x100/EFEFEF/AAAAAA&text=No+Image";
        employeeNameDisplay.textContent = employeeInfo.name || "Unknown Name";
        employeeInfoContainer.style.display = "block";
        verifiedEmployeeId.value = employeeId;
        document.getElementById("statusRequestId").textContent = requestId;

        showContainer("waitingContainer");

        // Handle display based on the status
        if (leaveStatus.status === "Rejected") {
          updateStatusDisplay(
            leaveStatus.status,
            leaveStatus.leaveType,
            leaveStatus.reason
          );
        } else if (leaveStatus.status === "Pending") {
          updateStatusDisplay("Pending");
          startSmartPolling();
          // Immediately disable the return button when resuming a pending state
          const returnBtn = document.getElementById("returnToFormButton");
          returnBtn.disabled = true;
          returnBtn.classList.add("bg-gray-400", "cursor-not-allowed");
          returnBtn.classList.remove("bg-gray-600", "hover:bg-gray-700");
          document.getElementById("returnTimer").textContent = "";
        } else {
          // If status is something else (e.g., Approved but user closed tab before receipt showed)
          // Let the normal verification flow handle it.
          goBackToVerification();
        }
      }

      // --- Camera and Image Handling ---
      function openModal(modalId) {
        document.getElementById(modalId).classList.remove("hidden");
        document.getElementById(modalId).classList.add("flex");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.add("hidden");
        document.getElementById(modalId).classList.remove("flex");
      }
      function showInfoModal(title, message) {
        document.getElementById("infoModalTitle").textContent = title;
        document.getElementById("infoModalMessage").textContent = message;
        openModal("infoModal");
      }
      async function openCamera(facingMode) {
        currentFacingMode = facingMode;
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          const constraints = {
            video: {
              facingMode: currentFacingMode,
              width: { ideal: 640 },
              height: { ideal: 480 },
            },
          };
          try {
            cameraStream = await navigator.mediaDevices.getUserMedia(
              constraints
            );
            videoElement.srcObject = cameraStream;
            videoElement.style.transform =
              currentFacingMode === "user" ? "scaleX(-1)" : "scaleX(1)";
            videoElement.onloadedmetadata = () => {
              videoElement.play();
              openModal("camera-modal");
              cameraMessage.textContent = "សូមតម្រង់កាមេរ៉ាឲ្យបានត្រឹមត្រូវ";
            };
          } catch (error) {
            console.error("Error accessing camera: ", error);
            showToast("មិនអាចបើកកាមេរ៉ាបានទេ។", "error");
          }
        } else {
          showToast("កម្មវិធីរុករករបស់អ្នកមិនគាំទ្រមុខងារកាមេរ៉ាទេ។", "error");
        }
      }
      function openCameraWithNotice(type) {
        captureTarget = type;
        let facingMode = "user";
        let notice = "សូមប្រាកដថាថតរូបមុខបានច្បាស់!";
        if (type === "document") {
          if (documentImages.length >= 4) {
            showToast("អាចបញ្ចូលបានតែ 4 រូប", "info");
            return;
          }
          facingMode = "environment";
          notice = "សូមថតរូបឯកសារឱ្យបានច្បាស់។";
        }
        showInfoModal("លក្ខខណ្ឌថតរូប", notice);
        document.getElementById("infoModal").querySelector("button").onclick =
          () => {
            closeModal("infoModal");
            openCamera(facingMode);
          };
      }
      function closeCamera() {
        if (cameraStream)
          cameraStream.getTracks().forEach((track) => track.stop());
        closeModal("camera-modal");
      }
      function switchCamera() {
        currentFacingMode =
          currentFacingMode === "user" ? "environment" : "user";
        if (cameraStream)
          cameraStream.getTracks().forEach((track) => track.stop());
        openCamera(currentFacingMode);
      }
      function handleFileSelect(event) {
        const files = event.target.files;
        if (files.length + documentImages.length > 4) {
          showToast(
            `អាចជ្រើសរើសបានតែ ${4 - documentImages.length} បន្ថែម`,
            "info"
          );
          return;
        }
        for (let i = 0; i < files.length; i++) {
          const reader = new FileReader();
          reader.onload = function (e) {
            documentImages.push(e.target.result);
            renderDocumentPreviews();
          };
          reader.readAsDataURL(files[i]);
        }
      }
      function renderDocumentPreviews() {
        documentPreviewContainer.innerHTML = "";
        documentImages.forEach((imgData, index) => {
          const thumbContainer = document.createElement("div");
          thumbContainer.className = "thumbnail-container";
          const img = document.createElement("img");
          img.src = imgData;
          img.className = "w-20 h-20 object-cover rounded-lg";
          const removeBtn = document.createElement("div");
          removeBtn.className = "thumbnail-remove-btn";
          removeBtn.innerHTML = "&times;";
          removeBtn.onclick = () => removeDocumentImage(index);
          thumbContainer.appendChild(img);
          thumbContainer.appendChild(removeBtn);
          documentPreviewContainer.appendChild(thumbContainer);
        });
        documentImageDataInput.value =
          documentImages.length > 0 ? JSON.stringify(documentImages) : "";
        checkFormValidity();
      }
      function removeDocumentImage(index) {
        documentImages.splice(index, 1);
        renderDocumentPreviews();
      }
      function capturePhoto() {
        const context = canvasElement.getContext("2d");
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        if (currentFacingMode === "user") {
          context.translate(canvasElement.width, 0);
          context.scale(-1, 1);
        }
        context.drawImage(
          videoElement,
          0,
          0,
          canvasElement.width,
          canvasElement.height
        );
        context.setTransform(1, 0, 0, 1, 0, 0);
        const dataUrl = canvasElement.toDataURL("image/jpeg", 0.9);
        if (captureTarget === "selfie") {
          selfieImageDataInput.value = dataUrl;
          selfiePreview.src = dataUrl;
          selfiePreviewContainer.classList.remove("hidden");
        } else if (captureTarget === "document") {
          if (documentImages.length < 4) {
            documentImages.push(dataUrl);
            renderDocumentPreviews();
          }
        } else if (captureTarget === "check-in") {
          document.getElementById("checkInImageData").value = dataUrl;
          document.getElementById("checkInPreview").src = dataUrl;
          document
            .getElementById("checkInPreviewContainer")
            .classList.remove("hidden");
          document.getElementById("submitCheckInButton").disabled = false;
        }
        closeCamera();
        checkFormValidity();
      }
      function removeSelfiePhoto() {
        selfieImageDataInput.value = "";
        selfiePreview.src = "";
        selfiePreviewContainer.classList.add("hidden");
        checkFormValidity();
      }
      function removeDocumentPhoto() {
        documentImages = [];
        renderDocumentPreviews();
      }
      function removeCheckInPhoto() {
        document.getElementById("checkInImageData").value = "";
        document.getElementById("checkInPreview").src = "";
        document
          .getElementById("checkInPreviewContainer")
          .classList.add("hidden");
        document.getElementById("submitCheckInButton").disabled = true;
      }
      function dataURItoBlob(dataURI) {
        const byteString = atob(dataURI.split(",")[1]);
        const mimeString = dataURI.split(",")[0].split(":")[1].split(";")[0];
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        return new Blob([ab], { type: mimeString });
      }

      // --- Submission and Server Communication ---
      function openBankModal() {
        closeModal("paymentNoticeModal");
        openModal("bankPaymentModal");
      }

      async function handleLeaveSubmit() {
        setButtonLoadingState("submitLeave", true);

        // Step 1: Get Location
        let position = null;
        try {
          showToast("កំពុងកំណត់ទីតាំង...", "info");
          position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0,
            });
          });
          showToast("កំណត់ទីតាំងបានជោគជ័យ", "success");
        } catch (error) {
          showToast("មិនអាចកំណត់ទីតាំងបានទេ, បន្តដោយគ្មានទីតាំង។", "info");
        }

        const isPermission = leaveTypeSelect.value === "ច្បាប់ចេញក្រៅ";
        const selectedDaysText = isPermission
          ? permissionDaysSelect.value
          : leaveDaysSelect.value;

        pendingSubmissionDetails = {
          employeeId: verifiedEmployeeId.value,
          employeeName: currentEmployeeName,
          leaveType: leaveTypeSelect.value,
          startDate: startDateInput.value,
          endDate: endDateInput.value,
          numberOfDays: selectedDaysText,
          reason: reasonInput.value,
          selfieImageData: selfieImageDataInput.value,
          documentImageData: documentImageDataInput.value,
          paymentReceiptImageData: null,
          latitude: position ? position.coords.latitude : null,
          longitude: position ? position.coords.longitude : null,
          requestId: currentRequestId, // Include requestId if it's an update
        };

        // Step 2: Check for duplicate requests
        google.script.run
          .withSuccessHandler(async (duplicateResponse) => {
            if (duplicateResponse.isDuplicate) {
              showToast(duplicateResponse.message, "error");
              setButtonLoadingState("submitLeave", false);
              return;
            }

            // Step 3: Face Comparison (only if selfie is provided)
            if (
              pendingSubmissionDetails.selfieImageData &&
              pendingSubmissionDetails.selfieImageData.startsWith(
                "data:image"
              ) &&
              currentEmployeePhotoUrl
            ) {
              showToast("កំពុងប្រៀបធៀបផ្ទៃមុខ...", "info");
              if (!modelsLoaded) {
                showToast(
                  "ទិន្នន័យសម្គាល់មិនទាន់រួចរាល់ទេ។ សូមរង់ចាំបន្តិច។",
                  "error"
                );
                setButtonLoadingState("submitLeave", false);
                return;
              }
              try {
                const referenceImage = await faceapi.fetchImage(
                  currentEmployeePhotoUrl
                );
                const queryImage = await faceapi.bufferToImage(
                  dataURItoBlob(pendingSubmissionDetails.selfieImageData)
                );
                const options = new faceapi.TinyFaceDetectorOptions({
                  inputSize: 320,
                });
                const referenceResult = await faceapi
                  .detectSingleFace(referenceImage, options)
                  .withFaceLandmarks()
                  .withFaceDescriptor();
                const queryResult = await faceapi
                  .detectSingleFace(queryImage, options)
                  .withFaceLandmarks()
                  .withFaceDescriptor();

                if (!referenceResult || !queryResult) {
                  showToast(
                    "មិនអាចសម្គាល់ផ្ទៃមុខក្នុងរូបថតបានទេ។ សូមព្យាយាមម្តងទៀត។",
                    "error"
                  );
                  setButtonLoadingState("submitLeave", false);
                  return;
                }

                const faceMatcher = new faceapi.FaceMatcher(referenceResult);
                const bestMatch = faceMatcher.findBestMatch(
                  queryResult.descriptor
                );

                if (bestMatch.distance > 0.55) {
                  showToast(
                    `រូបថតមិនត្រឹមត្រូវ! (${(
                      (1 - bestMatch.distance) *
                      100
                    ).toFixed(0)}%) សូមប្រាកដថាជាម្ចាស់អត្តលេខផ្ទាល់។`,
                    "error"
                  );
                  setButtonLoadingState("submitLeave", false);
                  return;
                }
                showToast(
                  `ផ្ទៀងផ្ទាត់ផ្ទៃមុខបានជោគជ័យ (${(
                    (1 - bestMatch.distance) *
                    100
                  ).toFixed(0)}%)`,
                  "success"
                );
              } catch (error) {
                console.error("Face comparison error:", error);
                showToast("មានបញ្ហាក្នុងការប្រៀបធៀបផ្ទៃមុខ។", "error");
                setButtonLoadingState("submitLeave", false);
                return;
              }
            }

            // Step 4: Conditional Payment Modal
            const isUpdate = !!currentRequestId;
            const requiresRepayment =
              currentRejectionReason === "ប្អូនមិនទាន់បង់សេវារដ្ឋបាលទេ!";

            if (isUpdate && !requiresRepayment) {
              finalizeSubmission(true); // Skip payment modal
            } else {
              openModal("bankPaymentModal"); // Show payment for new requests or payment-related rejections
              setButtonLoadingState("submitLeave", false);
            }
          })
          .withFailureHandler((err) => {
            showToast("Error checking for duplicates: " + err.message, "error");
            setButtonLoadingState("submitLeave", false);
          })
          .checkForDuplicateRequests(pendingSubmissionDetails);
      }

      function finalizeSubmission(skipPayment = false) {
        if (!skipPayment) {
          closeModal("bankPaymentModal");
        }
        if (!pendingSubmissionDetails) return;

        setButtonLoadingState("submitLeave", true);

        if (!skipPayment) {
          pendingSubmissionDetails.paymentReceiptImageData =
            document.getElementById("paymentReceiptImageData").value;
        } else {
          pendingSubmissionDetails.paymentReceiptImageData = null; // Ensure no payment data is sent
        }

        const functionToCall = currentRequestId
          ? "updateLeaveRequest"
          : "submitLeaveRequest";

        runServerFunction(
          "submitLeave",
          functionToCall,
          pendingSubmissionDetails,
          onSubmissionSuccess
        );
      }

      function onSubmissionSuccess(response) {
        if (response.status === "success") {
          const reqId = currentRequestId || response.requestId;
          localStorage.setItem("pendingRequestId", reqId);
          localStorage.setItem("pendingEmployeeId", verifiedEmployeeId.value);
          document.getElementById("statusRequestId").textContent = reqId;
          showContainer("waitingContainer");
          updateStatusDisplay("Pending");

          startSmartPolling();
          startReturnButtonTimer();

          currentRequestId = null;
          pendingSubmissionDetails = null;
          currentRejectionReason = ""; // Clear rejection reason after submission
          submitButtonText.textContent = "ដាក់ស្នើ";
          leaveRequestForm.reset();
          initializeForm();
        }
      }

      function startSmartPolling() {
        stopAllPollers();
        pollCount = 0;
        checkRequestStatus();
      }

      function checkRequestStatus() {
        const requestId = localStorage.getItem("pendingRequestId");
        if (!requestId) {
          stopAllPollers();
          return;
        }

        const cacheBuster = new Date().getTime(); // Create a unique value

        google.script.run
          .withSuccessHandler((response) => {
            if (response && response.status && response.status !== "Error") {
              updateStatusDisplay(
                response.status,
                response.leaveType,
                response.reason
              );
              if (response.status === "Pending") {
                pollCount++;
                // UPDATED: Poll every 1 second for the first 30 polls (30 seconds), then slow down to 5 seconds.
                const delay = pollCount < 30 ? 1000 : 5000;
                statusCheckTimeout = setTimeout(checkRequestStatus, delay);
              }
            }
          })
          .getRequestStatus(requestId, cacheBuster); // Pass the cache buster
      }

      function startAdminCheckInPoller(requestId) {
        stopAllPollers();
        adminCheckedInPoller = setInterval(() => {
          const cacheBuster = new Date().getTime();
          google.script.run
            .withSuccessHandler((response) => {
              if (response && response.status === "AdminCheckedIn") {
                stopAllPollers();
                localStorage.removeItem("approvedReceiptData");
                showContainer("adminCheckedInContainer");
                setTimeout(() => {
                  goBackToVerification();
                }, 6000);
              }
            })
            .getRequestStatus(requestId, cacheBuster);
        }, 5000);
      }

      function showCheckInForm(requestId) {
        document.getElementById("checkInRequestId").value = requestId;
        removeCheckInPhoto();
        showContainer("checkInContainer");
      }

      async function handleSubmitCheckIn() {
        setButtonLoadingState("submitCheckIn", true);

        const checkInData = {
          requestId: document.getElementById("checkInRequestId").value,
          selfieData: document.getElementById("checkInImageData").value,
          latitude: null,
          longitude: null,
        };

        if (checkInData.selfieData && currentEmployeePhotoUrl) {
          showToast("កំពុងប្រៀបធៀបផ្ទៃមុខ...", "info");
          if (!modelsLoaded) {
            showToast(
              "ទិន្នន័យសម្គាល់មិនទាន់រួចរាល់ទេ។ សូមរង់ចាំបន្តិច។",
              "error"
            );
            setButtonLoadingState("submitCheckIn", false);
            return;
          }
          try {
            const referenceImage = await faceapi.fetchImage(
              currentEmployeePhotoUrl
            );
            const queryImage = await faceapi.bufferToImage(
              dataURItoBlob(checkInData.selfieData)
            );
            const options = new faceapi.TinyFaceDetectorOptions({
              inputSize: 320,
            });
            const referenceResult = await faceapi
              .detectSingleFace(referenceImage, options)
              .withFaceLandmarks()
              .withFaceDescriptor();
            const queryResult = await faceapi
              .detectSingleFace(queryImage, options)
              .withFaceLandmarks()
              .withFaceDescriptor();

            if (!referenceResult || !queryResult) {
              showToast(
                "មិនអាចសម្គាល់ផ្ទៃមុខក្នុងរូបថតបានទេ។ សូមព្យាយាមម្តងទៀត។",
                "error"
              );
              setButtonLoadingState("submitCheckIn", false);
              return;
            }

            const faceMatcher = new faceapi.FaceMatcher(referenceResult);
            const bestMatch = faceMatcher.findBestMatch(queryResult.descriptor);

            if (bestMatch.distance > 0.55) {
              showToast(
                `រូបថតមិនត្រឹមត្រូវ! (${(
                  (1 - bestMatch.distance) *
                  100
                ).toFixed(0)}%) សូមប្រាកដថាជាម្ចាស់អត្តលេខផ្ទាល់។`,
                "error"
              );
              setButtonLoadingState("submitCheckIn", false);
              return;
            }
            showToast(
              `ផ្ទៀងផ្ទាត់ផ្ទៃមុខបានជោគជ័យ (${(
                (1 - bestMatch.distance) *
                100
              ).toFixed(0)}%)`,
              "success"
            );
          } catch (error) {
            console.error("Face comparison error:", error);
            showToast("មានបញ្ហាក្នុងការប្រៀបធៀបផ្ទៃមុខ។", "error");
            setButtonLoadingState("submitCheckIn", false);
            return;
          }
        }

        const onCheckInSuccess = (response) => {
          if (response.status === "success") {
            showToast("ការបញ្ជាក់ចូលមកវិញបានជោគជ័យ!", "success");
            setTimeout(() => {
              localStorage.removeItem("approvedReceiptData");
              goBackToVerification();
            }, 1500);
          }
        };

        showToast("កំពុងកំណត់ទីតាំង...", "info");
        navigator.geolocation.getCurrentPosition(
          (position) => {
            checkInData.latitude = position.coords.latitude;
            checkInData.longitude = position.coords.longitude;
            runServerFunction(
              "submitCheckIn",
              "submitCheckIn",
              checkInData,
              onCheckInSuccess
            );
          },
          (error) => {
            let errorMessage = "មិនអាចកំណត់ទីតាំងបានទេ។ សូមព្យាយាមម្តងទៀត។";
            if (error.code === 1)
              errorMessage = "សូមអនុញ្ញាតឲ្យកម្មវិធីប្រើប្រាស់ទីតាំង។";
            showToast(errorMessage, "error");
            setButtonLoadingState("submitCheckIn", false);
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      }

      function setButtonLoadingState(buttonType, isLoading) {
        const btn = document.getElementById(`${buttonType}Button`);
        const btnText = document.getElementById(`${buttonType}ButtonText`);
        const loader = document.getElementById(`${buttonType}Loader`);
        if (btn) btn.disabled = isLoading;
        if (loader) loader.classList.toggle("hidden", !isLoading);
        if (btnText) btnText.style.display = isLoading ? "none" : "inline";
      }

      function runServerFunction(
        buttonType,
        functionName,
        arg,
        successCallback
      ) {
        setButtonLoadingState(buttonType, true);
        google.script.run
          .withSuccessHandler((response) => {
            setButtonLoadingState(buttonType, false);
            if (response && response.status === "error") {
              showToast(response.message, "error");
            } else {
              if (successCallback) successCallback(response);
            }
          })
          .withFailureHandler((error) => {
            setButtonLoadingState(buttonType, false);
            showToast("Error: " + error.message, "error");
          })
          [functionName](arg);
      }

      function showToast(message, type = "info", duration = 4000) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;

        const icons = {
          success:
            '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
          error:
            '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
          info: '<svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        };

        toast.innerHTML = `
                ${icons[type]}
                <p class="ml-3 font-medium text-sm">${message}</p>
            `;

        container.appendChild(toast);

        setTimeout(() => {
          toast.classList.add("show");
        }, 10);

        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            container.removeChild(toast);
          }, 500);
        }, duration);
      }

      function startReturnButtonTimer() {
        const button = document.getElementById("returnToFormButton");
        const timerSpan = document.getElementById("returnTimer");
        let secondsLeft = 30;

        button.disabled = false;
        button.classList.remove("bg-gray-400", "cursor-not-allowed");
        button.classList.add("bg-gray-600", "hover:bg-gray-700");

        timerSpan.textContent = `(${secondsLeft}s)`;

        if (returnButtonTimer) clearInterval(returnButtonTimer);

        returnButtonTimer = setInterval(() => {
          secondsLeft--;
          timerSpan.textContent = `(${secondsLeft}s)`;
          if (secondsLeft <= 0) {
            clearInterval(returnButtonTimer);
            button.disabled = true;
            button.classList.remove("bg-gray-600", "hover:bg-gray-700");
            button.classList.add("bg-gray-400", "cursor-not-allowed");
            timerSpan.textContent = "";
          }
        }, 1000);
      }

      function startBankPaymentTimer() {
        if (bankPaymentTimer) clearInterval(bankPaymentTimer);

        const button = document.getElementById("bankPaymentPaidButton");
        let secondsLeft = 10;

        button.disabled = true;
        button.classList.add("bg-gray-400", "cursor-not-allowed");
        button.classList.remove("bg-green-600", "hover:bg-green-700");
        button.textContent = `បានទូទាត់រួច (${secondsLeft}s)`;

        bankPaymentTimer = setInterval(() => {
          secondsLeft--;
          if (secondsLeft > 0) {
            button.textContent = `បានទូទាត់រួច (${secondsLeft}s)`;
          } else {
            clearInterval(bankPaymentTimer);
            button.textContent = "បានទូទាត់រួច";
            // The button remains disabled until a receipt is uploaded.
            // It will be enabled in the handleReceiptUpload function.
          }
        }, 1000);
      }

      function handleReceiptUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById("paymentReceiptImageData").value =
            e.target.result;
          uploadReceiptLabel.querySelector("span").textContent =
            "បាន Upload វិក័យបត្រ";
          uploadReceiptLabel.classList.add("bg-green-100", "text-green-700");

          bankPaymentPaidButton.disabled = false;
          bankPaymentPaidButton.classList.remove(
            "bg-gray-400",
            "cursor-not-allowed"
          );
          bankPaymentPaidButton.classList.add(
            "bg-green-600",
            "hover:bg-green-700"
          );
          if (bankPaymentTimer) clearInterval(bankPaymentTimer);
          bankPaymentPaidButton.textContent = "បានទូទាត់រួច";
        };
        reader.readAsDataURL(file);
      }

      function removePaymentReceipt() {
        document.getElementById("paymentReceiptImageData").value = "";
        uploadReceiptLabel.querySelector("span").textContent =
          "Upload វិក័យបត្រ";
        uploadReceiptLabel.classList.remove("bg-green-100", "text-green-700");
        bankPaymentPaidButton.disabled = true;
        bankPaymentPaidButton.classList.add(
          "bg-gray-400",
          "cursor-not-allowed"
        );
        bankPaymentPaidButton.classList.remove(
          "bg-green-600",
          "hover:bg-green-700"
        );
        paymentReceiptUpload.value = ""; // Reset file input
      }

      function handleVerificationSubmit(event) {
        event.preventDefault();
        const employeeId = employeeIdInput.value.trim();
        if (!employeeId) {
          showToast("សូម​បញ្ចូល​អត្តលេខ។", "error");
          return;
        }
        if (employeeId === "0011") {
          showContainer("adminLoginContainer");
          return;
        }

        setButtonLoadingState("verify", true);
        showToast("កំពុងពិនិត្យ...", "info");

        google.script.run
          .withSuccessHandler((response) => {
            setButtonLoadingState("verify", false);

            if (response.verificationStatus === "error") {
              showToast(response.message, "error");
              return;
            }

            const { employeeInfo, leaveStatus } = response;
            currentEmployeeName = employeeInfo.name;
            currentEmployeePhotoUrl = employeeInfo.photoUrl;

            switch (leaveStatus.status) {
              case "Pending":
                resumePendingState(
                  leaveStatus.requestId,
                  employeeId,
                  employeeInfo,
                  leaveStatus
                );
                break;
              case "Rejected":
                resumePendingState(
                  leaveStatus.requestId,
                  employeeId,
                  employeeInfo,
                  leaveStatus
                );
                break;
              case "Approved":
                setButtonLoadingState("verify", true);
                showToast("រកឃើញច្បាប់ដែលត្រូវបញ្ជាក់...", "info");
                google.script.run
                  .withSuccessHandler((detailsResponse) => {
                    if (detailsResponse.status === "success") {
                      populateAndShowReceipt(
                        leaveStatus.requestId,
                        detailsResponse.data
                      );
                    } else {
                      showToast(detailsResponse.message, "error");
                    }
                    setButtonLoadingState("verify", false);
                  })
                  .withFailureHandler((err) => {
                    showToast(
                      "Error fetching details: " + err.message,
                      "error"
                    );
                    setButtonLoadingState("verify", false);
                  })
                  .getLeaveRequestDetails(leaveStatus.requestId);
                break;
              case "Clear":
              case "AdminCheckedIn":
                employeePhoto.src =
                  employeeInfo.photoUrl ||
                  "https://placehold.co/100x100/EFEFEF/AAAAAA&text=No+Image";
                employeeNameDisplay.textContent =
                  employeeInfo.name || "Unknown Name";
                employeeInfoContainer.style.display = "flex";
                verifiedEmployeeId.value = employeeId;
                showContainer("leaveRequestContainer");
                break;
              default:
                showToast(
                  leaveStatus.message || "An unknown error occurred.",
                  "error"
                );
                break;
            }
          })
          .withFailureHandler((error) => {
            setButtonLoadingState("verify", false);
            showToast("Server error: " + error.message, "error");
          })
          .verifyEmployeeAndGetStatus(employeeId);
      }

      function handleAdminLoginSubmit(event) {
        event.preventDefault();
        const password = document.getElementById("adminPasswordInput").value;
        runServerFunction(
          "adminLogin",
          "checkAdminPassword",
          password,
          (response) => {
            if (response.status === "success") {
              showToast("Login successful! Redirecting...", "success");
              setTimeout(() => (window.top.location.href = response.url), 1000);
            }
          }
        );
      }
    </script>
  </body>
</html>
